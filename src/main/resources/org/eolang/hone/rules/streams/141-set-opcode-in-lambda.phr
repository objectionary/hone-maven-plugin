# SPDX-FileCopyrightText: Copyright (c) 2024-2025 Objectionary.com
# SPDX-License-Identifier: MIT
---
# yamllint disable rule:line-length
name: set-opcode-in-lambda
pattern: |
  ⟦
    φ ↦ Φ.hone.lambda,
    class ↦ 𝑒-class,
    method ↦ 𝑒-method,
    interface ↦ 𝑒-interface,
    lambda-signature ↦ 𝑒-lambda-signature,
    bridge-signature ↦ 𝑒-bridge-signature,
    static ↦ 𝑒-static,
    opcode ↦ "",
    target ↦ ⟦
      handle ↦ 𝑒-target-handle,
      class ↦ 𝑒-target-class,
      method ↦ 𝑒-target-method,
      signature ↦ 𝑒-target-signature,
      is-interface ↦ 𝑒-target-is-interface
    ⟧,
    stream ↦ 𝑒-stream
  ⟧
result: |
  ⟦
    φ ↦ Φ.hone.lambda,
    class ↦ 𝑒-class,
    method ↦ 𝑒-method,
    interface ↦ 𝑒-interface,
    lambda-signature ↦ 𝑒-lambda-signature,
    bridge-signature ↦ 𝑒-bridge-signature,
    static ↦ 𝑒-static,
    opcode ↦ 𝑒-opcode,
    target ↦ ⟦
      handle ↦ 𝑒-target-handle,
      class ↦ 𝑒-target-class,
      method ↦ 𝑒-target-method,
      signature ↦ 𝑒-target-signature,
      is-interface ↦ 𝑒-target-is-interface
    ⟧,
    stream ↦ 𝑒-stream
  ⟧
where:
  - meta: 𝑒-opcode-from-singature
    function: sed
    args:
      - 𝑒-target-signature
      - '"s/\\(\\).+/invokevirtual/g"'
      - '"s/\\(.+\\).+/invokestatic/g"'
  - meta: 𝑒-opcode-from-static
    function: sed
    args:
      - 𝑒-static
      - '"s/true/invokestatic/g"'
      - '"s/false/invokevirtual/g"'
  - meta: 𝑒-opcodes
    function: concat
    args: [𝑒-opcode-from-singature, '"-"', 𝑒-opcode-from-static]
  - meta: 𝑒-opcode
    function: sed
    args:
      - 𝑒-opcodes
      - '"s/.+-invokevirtual/invokevirtual/g"'
      - '"s/(.+)-invokestatic/$1/g"'
